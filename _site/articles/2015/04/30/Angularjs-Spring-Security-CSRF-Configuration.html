<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width initial-scale=1">

<meta property="og:title" content="Angularjs Spring Security CSRF configuration">
<title>Angularjs Spring Security CSRF configuration</title>
<meta property="og:description" content="Recently, my current project is built by Spring mvc framework, and base on project requirement, also integrated with Spring security. My project use spring 4...">
<meta property="og:url" content="http://superclark.co/articles/2015/04/30/Angularjs-Spring-Security-CSRF-Configuration.html">
<meta property="og:site_name" content="Superclark">
<meta property="og:locale" content="en_US">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@Clark_theSuper">
<meta name="twitter:creator" content="@Clark_theSuper">
<meta name="twitter:title" content="Angularjs Spring Security CSRF configuration">
<meta name="twitter:description" content="Recently, my current project is built by Spring mvc framework, and base on project requirement, also integrated with Spring security. My project use spring 4...">
<meta name="twitter:url" content="http://superclark.co/articles/2015/04/30/Angularjs-Spring-Security-CSRF-Configuration.html">

<meta name="keywords" content="Technology, clark, skiing">

<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://superclark.co/articles/2015/04/30/Angularjs-Spring-Security-CSRF-Configuration.html">
<link rel="alternate" type="application/atom+xml" title="Superclark" href="http://superclark.co/feed.xml" />

<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script language="Javascript" type="text/javascript">
function search_google()
{
  var query = document.getElementById("google-search").value;
  window.open("http://google.com/search?q=" + query
      + "%20site:" + "http://superclark.co");
}
</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script type='text/javascript'>
var blocklink = ['http://humanorightswatch.org','http://o-o-6-o-o.com','http://darodar.com','http://blackhatworth.com','http://hulfingtonpost.com','http://bestwebsitesawards.com','http://darodar.com','http://buttons-for-website.com','http://ilovevitaly.co','http://semalt.com','http://priceg.com','http://simple-share-buttons.com','http://googlsucks.com','http://4webmasters.org','http://aliexpress.com','http://addons.mozilla.org/en-US/firefox/addon/ilovevitaly/'];
for (var b = blocklink.length; b--;) {
  if (document.referrer.match(blocklink[b]))
    window.location = "http://www.google.com";
}
</script>




</head>


<body>

<div class="container">

  <header class="site-header">

  <div class="wrapper">

    <h1 class="site-title"><a href="/">Superclark</a></h1>
    <h3 class="site-meta">Technology and Skiing</h3>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
        
        <a class="page-link" href="/">Home</a>
        
        
        
        <a class="page-link" href="/about/">About</a>
        
        
        
        <a class="page-link" href="/archives/">Archives</a>
        
        
        
        <a class="page-link" href="/categories/">Categories</a>
        
        
        
        <a class="page-link" href="/tags/">Tags</a>
        
        
        
        <a class="page-link" href="/guestbook/">Guestbook</a>
        
        
        
        <a class="page-link" href="/feed.xml">Subscribe</a>
        
        
        
        
        
        
        
        
      </div>
    </nav>

  </div>

</header>


    

  <div class="page-content col-sm-8">
    <div class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 itemprop="name" class="post-title">Angularjs Spring Security CSRF configuration</h1>
    <meta itemprop="keywords" content="Angularjs,Spring Security" />
    <p class="post-meta">
    Posted in
    
    <a href="/categories/#articles">articles</a>&nbsp;
     
    
    and tagged
    
    <a href="/tags/#Angularjs" title="Angularjs">Angularjs </a>, 
    
    <a href="/tags/#Spring Security" title="Spring Security">Spring Security </a>
    
    
    <time itemprop="datePublished" datetime="2015-04-30">
    on Apr 30, 2015
    </time>
    </p>
  </header>

  <article class="post-content" itemprop="articleBody">
    <p>Recently, my current project is built by Spring mvc framework, and base on project requirement, also integrated with Spring security. My project use spring 4.0 and spring security 3.2.8. To prevent Cross-Site Request Forgery attack, I enable csrf in my spring security context.</p>

<p>We can set a simple spring security context like this:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="nt">&lt;beans:beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/security"</span>
    <span class="na">xmlns:beans=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans</span>
                        <span class="err">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
                        <span class="err">http://www.springframework.org/schema/security</span>
                        <span class="err">http://www.springframework.org/schema/security/spring-security-3.2.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;http</span> <span class="na">auto-config=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;intercept-url</span> <span class="na">pattern=</span><span class="s">"/admin**"</span> <span class="na">access=</span><span class="s">"ROLE_SUPERUSER"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;csrf/&gt;</span>
    <span class="nt">&lt;/http&gt;</span>

    <span class="nt">&lt;authentication-manager&gt;</span>
      <span class="nt">&lt;authentication-provider&gt;</span>
        <span class="nt">&lt;user-service&gt;</span>
        <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">"clark"</span> <span class="na">password=</span><span class="s">"123456"</span> <span class="na">authorities=</span><span class="s">"ROLE_SUPERUSER"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/user-service&gt;</span>
      <span class="nt">&lt;/authentication-provider&gt;</span>
    <span class="nt">&lt;/authentication-manager&gt;</span>

<span class="nt">&lt;/beans:beans&gt;</span><span class="w">
</span></pre></td></tr></tbody></table>



Now, for normal form we can insert a hidden input to post: the hidden param name set to _csrf.parameterName and param value set to _csrf.token.

If we just use normal form post, everything is perfect now. But if we want to have a better front side user experience, for example, we want to use ajax to handle data and send data to server in order to stay on a static page, normal spring security csrf setting is not enough.

Base on spring docs, if we use jQuery or rest.js, it’s easy for us to setup, because following the spring docs is enough. But the trouble is that i use angularjs to do the front side data handling, angularjs has its own csrf protection setting, which is xsrf. Now, spring csrf normal setting is not enough for us.  We need to change spring csrf token to angularjs xsrf token.

To accomplish this, we need to change csrf headerName in our spring security context:


<div class="highlight"><pre><code class="language-xml" data-lang="xml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="nt">&lt;beans:beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/security"</span>
    <span class="na">xmlns:beans=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans</span>
    <span class="err">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
    <span class="err">http://www.springframework.org/schema/security</span>
    <span class="err">http://www.springframework.org/schema/security/spring-security-3.2.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;http</span> <span class="na">auto-config=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;intercept-url</span> <span class="na">pattern=</span><span class="s">"/admin**"</span> <span class="na">access=</span><span class="s">"ROLE_SUPERUSER"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;csrf</span> <span class="na">token-repository-ref=</span><span class="s">"csrfTokenRepository"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/http&gt;</span>

    <span class="nt">&lt;authentication-manager&gt;</span>
      <span class="nt">&lt;authentication-provider&gt;</span>
        <span class="nt">&lt;user-service&gt;</span>
        <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">"clark"</span> <span class="na">password=</span><span class="s">"123456"</span> <span class="na">authorities=</span><span class="s">"ROLE_SUPERUSER"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/user-service&gt;</span>
      <span class="nt">&lt;/authentication-provider&gt;</span>
    <span class="nt">&lt;/authentication-manager&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"csrfTokenRepository"</span> <span class="na">class=</span><span class="s">"org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"headerName"</span> <span class="na">value=</span><span class="s">"X-XSRF-TOKEN"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>
<span class="nt">&lt;/beans:beans&gt;</span><span class="w">
</span></pre></td></tr></tbody></table>



For angularjs, we will use [spring-security-csrf-token-interceptor](http://github.com/aditzel/spring-security-csrf-token-interceptor) to get xsrf token from spring. Here we should give best thanks to the author aditzel for this easy tool. To use this tool is just adding this module to our angular app. Here i won’t write the detail. This interceptor will call from spring to get our xsrf token. So we also need a filter in our spring to send xsrf token for each request.

The custom filter will write like this:


<div class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CsrfFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span>
<span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="n">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">CsrfToken</span> <span class="n">csrf</span> <span class="o">=</span> <span class="o">(</span><span class="n">CsrfToken</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">CsrfToken</span><span class="o">.</span><span class="na">class</span>
                <span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">csrf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="s">"XSRF-TOKEN"</span><span class="o">,</span> <span class="n">csrf</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
            <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table>



Finally we will add this custom filter in our spring context.Now, we can use angularjs $http.post() to do server side data management. As for present, i found i still can use spring csrf input tag in my normal form post, this can give us lots of options to choose the most proper implementation in our project.
</code></pre></div></code></pre></div></code></pre></div>

  </article>
  <hr />
</div>


<section class="pager">
  <ul>
    
    <li class="disabled"><a>&larr; Older</a></li>
    
    
    <li class="next"><a href="/articles/2015/10/31/Null-or-Optional-in-Java.html" title="Null or Optional in Java">Newer &rarr;</a></li>
    
  </ul>
</section>

<div id="disqus_thread"></div>

<script type="text/javascript">

  var disqus_developer = 1;

var disqus_shortname ='superclark';
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    <section class="pager">
  
  
</section>


  </div>
  <div class="col-sm-2">
<div class="sidebar-module about">
  <h4>About Me</h4>
  <img title="Clark Zhang" src="https://farm4.staticflickr.com/3924/buddyicons/125798402@N08_r.jpg" alt="Clark Zhang"/>
  <span>Hi, this is Clark Zhang. I made Superclark to share leaning experience. Please enjoy it.</span>
  <br />

  

  You can contact me via: <br />

  
  <a href="mailto:zhangzongyangclark@gmail.com" title="mailto: zhangzongyangclark@gmail.com"><i class="fa fa-envelope-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://github.com/zzyclark" title="GithubID: zzyclark"><i class="fa fa-github-square fa-3x"></i></a>&nbsp;
  
  
  <a href="https://twitter.com/Clark_theSuper" title="TwitterID: Clark_theSuper"><i class="fa fa-twitter-square fa-3x"></i></a>
  

  

</div>

<div class="sidebar-module">
  <h4>Site Search</h4>
  <form onsubmit="search_google()" >
    <input type="text" id="google-search" placeholder="Google search" />
    <input type="submit" name="sa" value="Go" />
  </form>
</div>

<div class="sidebar-module">
  <h4>Recent Posts</h4>
  
  <li>
  <a href="//articles/2016/05/13/Build-Your-Own-Cache-Busting-Service.html" title="Build Your Own Cache Busting Service" rel="bookmark">Build Your Own Cache Busting Service</a>
  </li>
  
  <li>
  <a href="//articles/2015/12/16/CouchDB-with-Ektorp.html" title="CouchDB With Ektorp" rel="bookmark">CouchDB With Ektorp</a>
  </li>
  
  <li>
  <a href="//articles/2015/12/03/CouchDB%20with%20HibernateOGM.html" title="CouchDB With HibernateOGM" rel="bookmark">CouchDB With HibernateOGM</a>
  </li>
  
  <li>
  <a href="//articles/2015/11/09/Lambda-Expression-in-Java.html" title="Lambda Expression in Java" rel="bookmark">Lambda Expression in Java</a>
  </li>
  
  <li>
  <a href="//ski/2015/11/01/Ski-Trip-in-Bei-Da-Hu-Resort.html" title="Ski trip in Bei Da Hu" rel="bookmark">Ski trip in Bei Da Hu</a>
  </li>
  
</div>


<div class="sidebar-module">
  <h4>Categories</h4>
  
  <li><a href="/categories/#articles" title="articles" rel="6">articles (6)</a></li>
  
  <li><a href="/categories/#ski" title="ski" rel="1">ski (1)</a></li>
  
</div>


<div class="sidebar-module">
  <h4>Tags</h4>
  
    <a href="/tags/#Angularjs" title="Angularjs" rel="1">Angularjs</a> &nbsp;
  
    <a href="/tags/#Spring Security" title="Spring Security" rel="1">Spring Security</a> &nbsp;
  
    <a href="/tags/#Java" title="Java" rel="4">Java</a> &nbsp;
  
    <a href="/tags/#Ski" title="Ski" rel="1">Ski</a> &nbsp;
  
    <a href="/tags/#Travel" title="Travel" rel="1">Travel</a> &nbsp;
  
    <a href="/tags/#CouchDB" title="CouchDB" rel="2">CouchDB</a> &nbsp;
  
    <a href="/tags/#Nodejs" title="Nodejs" rel="1">Nodejs</a> &nbsp;
  
    <a href="/tags/#Javascript" title="Javascript" rel="1">Javascript</a> &nbsp;
  
</div>


<div class="sidebar-module">
  <h4>Blogroll</h4>
  
  <li><a href="http://superclark.co" title="Clark's tech blog">Clark Zhang</a></li>
  
</div>


<div class="sidebar-module">
  <h4>Archives</h4>

  
  
  
  
  
  <li id="2016" > <a href="/archives/#2016">2016</a></li>
  
  
  
  
  
  
  
  <li id="2015" > <a href="/archives/#2015">2015</a></li>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

</div>


<div class="sidebar-module">
  <h4>Visitors</h4>
  <script type="text/javascript" src="//ra.revolvermaps.com/0/0/1.js?i=08nxdj9ls7x&amp;s=220&amp;m=0&amp;v=false&amp;r=false&amp;b=000000&amp;n=false&amp;c=ff0000" async="async"></script>
  <a href="http://info.flagcounter.com/Flcu"><img src="http://s01.flagcounter.com/count2/Flcu/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_0/labels_0/pageviews_0/flags_0/percent_0/" alt="Flag Counter" border="0"></a>
</div>

</div>


  

  <footer class="site-footer">

  <p>Copyright &copy; <a href="/">Superclark</a></p>
  <p>Powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a>
  on
  
  <a href="https://github.com/">Github</a>
  


  <div id="totop" style="position:fixed;bottom:150px;right:50px;cursor: pointer;">
    <a title="Back To Top"><img src="/images/topbutton.png"/></a>
  </div>

  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/totop.js"></script>



</footer>


</div>

</body>

</html>
